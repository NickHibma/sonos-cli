#!/usr/bin/env node

var handleError = require('../lib/errorHandler')
var minimist = require('minimist')
var pkg = require('../package.json')
var getInitialDevice = require('../lib/getInitialDevice')
var getZoneController = require('../lib/getZoneController')

var argv = minimist(process.argv.slice(2))
var command = argv._[0]
var timeout = ((argv.timeout || argv.T) * 1000) || 5000

if (argv.version || argv.V) {
  console.log(pkg.version)
} else if (command === 'help') {
  console.log('Usage: sonos-cli [OPTION...] [COMMAND] [ARGS]')
  console.log('')
  console.log('  Options:')
  console.log('    -V --version - displays package.json version')
  console.log('    -T --timeout [time] - sets timeout time for sonos discovery')
  console.log('    -Z --zone [zoneid] - sets the zone to take action on')
  console.log('')
  console.log('  Commands:')
  console.log('')
  console.log('    help - display this help text')
  console.log('    list-devices')
  console.log('    list-zones')
  console.log('    volume')
  console.log('')
} else if (command === 'list-zones') {
  getInitialDevice(timeout, function (err, initDevice) {
    if (err) {
      return handleError(err)
    }
    require('../cmds/listZones')(initDevice)
  })
} else if (command === 'list-devices') {
  getInitialDevice(timeout, function (err, initDevice) {
    if (err) {
      return handleError(err)
    }
    require('../cmds/listDevices')(initDevice)
  })
} else if (command === 'volume') {
  if (!argv.zone) {
    return handleError(new Error('-zone must be specified'))
  }
  getZoneController(timeout, argv.zone, function (err, dev) {
    if (err) {
      return handleError(err)
    }
    dev.getVolume(function (err, vol) {
      if (err) {
        return handleError(err)
      }
      console.log(vol)
    })
  })
} else if (command === 'current-track') {
  if (!argv.zone) {
    return handleError(new Error('-zone must be specified'))
  }
  getZoneController(timeout, argv.zone, function (err, dev) {
    if (err) {
      return handleError(err)
    }
    dev.currentTrack(function (err, track) {
      if (err) {
        return handleError(err)
      }
      console.log('Title: ' + track.title)
      console.log('Album: ' + track.album)
      console.log('Artist: ' + track.artist)
    })
  })
} else {
  console.log('For help, run `sonos-cli help`')
}






