#!/usr/bin/env node

var minimist = require('minimist');
var sonos    = require('sonos');
var package  = require('../package.json');

var argv    = minimist(process.argv.slice(2));
var command = argv._[0];
var timeout = ((argv.timeout || argv.T) * 1000) || 5000;

if(argv.version || argv.V) {

  console.log(package.version);

} else if(argv.help || argv.H) {

  console.log('Usage: sonos-cli [OPTION...] [COMMAND] [ARGS]');
  console.log('');
  console.log('  Options:');
  console.log('    -V --version - displays package.json version');
  console.log('    -H --help - displays help');
  console.log('    -T --timeout - sets timeout time for sonos discovery');
  console.log('');
  console.log('  Commands:');
  console.log('');
  console.log('    TODO: play - starts music');
  console.log('    TODO: stop - stops music');
  console.log('    TODO: next - skips to next track');
  console.log('    current - Displays current media item');
  console.log('');

} else if(command) {

  var search = sonos.search();

  var timeoutFunc = setTimeout(function() {
    console.log('Unable to find Sonos device.');
    search.socket.close();
  }, timeout);

  search.once('DeviceAvailable', function(device) {

    clearTimeout(timeoutFunc);
    search.socket.close();

    device.currentTrack(function(err, currentTrack) {
      if(err) return console.error(err);
      console.log(currentTrack);
    });

  });

} else {

  console.log('For help, run `sonos-cli --help`');

}